
<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health Hub v3 ‚Äî Cloud Leaderboard + Weekly/Monthly Badges</title>
<link rel="stylesheet" href="./assets/css/style.css"/>
<script src="./assets/js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Health Game Hub ‚Äî Cloud + Weekly/Monthly Badges + Export</h1>
  <p class="small">‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ú‡πà‡∏≤‡∏ô Google Sheets ‚Ä¢ Badge ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ‚Ä¢ Export Excel</p>

  <div class="grid">
    <div class="card">
      <h2>üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô & ‡πÄ‡∏Å‡∏°</h2>
      <div class="row" style="grid-template-columns:repeat(4,1fr)">
        <div><div class="label">Student ID</div><input id="studentId" placeholder="STD001"/></div>
        <div><div class="label">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•</div><input id="studentName" placeholder="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢ A"/></div>
        <div><div class="label">‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡∏±‡πâ‡∏ô</div><input id="classId" placeholder="P5-A"/></div>
        <div><div class="label">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div><input id="school" placeholder="BKK School"/></div>
      </div>
      <div class="controls">
        <button id="setStudent" class="btn">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button id="goProfile" class="btn secondary">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <span id="activeStudentLabel" class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
      </div>
      <div class="row" style="grid-template-columns:2fr 1fr">
        <div>
          <div class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏°</div>
          <select id="gameSelect">
            <option value="handwash">üßº Handwash Quest</option>
            <option value="nutrition">ü•ó Nutrition Shop</option>
            <option value="dance">üíÉ Move & Dance</option>
            <option value="toothbrush">ü™• Toothbrush Dash</option>
            <option value="hydration">üíß Hydration Hero</option>
            <option value="balance">üßò Balance Ninja</option>
            <option value="germdefender">ü¶† Germ Defender</option>
            <option value="foodrush">üçé Healthy Food Rush</option>
          </select>
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="openBtn" class="btn">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°</button>
          <button id="resetAll" class="btn danger">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>
      <div class="note">‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå <b>embed.html</b> ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡∏±‡∏á‡πÉ‡∏ô Spatial.io (Web Frame)</div>
      <iframe id="stage" title="Stage"></iframe>
    </div>

    <div class="card">
      <h2>üèÜ Leaderboard & Export</h2>
      <div class="controls">
        <button id="syncSend" class="btn">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Sheets</button>
        <button id="syncFetchClass" class="btn secondary">‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‚Äî ‡∏´‡πâ‡∏≠‡∏á</button>
        <button id="syncFetchSchool" class="btn secondary">‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‚Äî ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button id="syncFetchDistrict" class="btn secondary">‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‚Äî ‡πÄ‡∏Ç‡∏ï</button>
      </div>
      <div class="controls">
        <div>
          <div class="label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
          <select id="period">
            <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
            <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
          </select>
        </div>
        <button id="exportExcel" class="btn">Export Excel</button>
        <a href="./dashboard_class.html" class="btn secondary" target="_blank">Class Dashboard</a>
        <a href="./dashboard_school.html" class="btn secondary" target="_blank">School Dashboard</a>
      </div>
      <div class="kpi">
        <div class="item"><h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</h3><div class="val" id="k_totalPoints">0</div></div>
        <div class="item"><h3>‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏ö</h3><div class="val" id="k_totalComps">0</div></div>
        <div class="item"><h3>Badge ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</h3><div class="val" id="k_badgesCount">0</div></div>
        <div class="item"><h3>‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏≤‡∏Å Badge</h3><div class="val" id="k_badgeBonus">0</div></div>
      </div>

      <h2 style="margin-top:12px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á</h2>
      <table class="table" id="tblClass"><thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>SID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡πÄ‡∏Å‡∏°‡∏à‡∏ö</th></tr></thead><tbody></tbody></table>
      <h2 style="margin-top:12px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
      <table class="table" id="tblSchool"><thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>SID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡πÄ‡∏Å‡∏°‡∏à‡∏ö</th></tr></thead><tbody></tbody></table>
      <h2 style="margin-top:12px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
      <table class="table" id="tblDistrict"><thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>SID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="footer">¬© Health Game WebXR Suite v3</div>
</div>

<script>
const games = {
  handwash:     {name:'Handwash Quest', url:'./handwash/embed.html', code:'HWQ'},
  nutrition:    {name:'Nutrition Shop', url:'./nutrition/embed.html', code:'NUT'},
  dance:        {name:'Move & Dance',   url:'./dance/embed.html',     code:'DANCE'},
  toothbrush:   {name:'Toothbrush Dash',url:'./toothbrush/embed.html',code:'TOOTH'},
  hydration:    {name:'Hydration Hero', url:'./hydration/embed.html', code:'HYDR'},
  balance:      {name:'Balance Ninja',  url:'./balance/embed.html',   code:'BAL'},
  germdefender: {name:'Germ Defender',  url:'./germdefender/embed.html', code:'GERM'},
  foodrush:     {name:'Healthy Food Rush', url:'./foodrush/embed.html',  code:'FOOD'}
};
const LSKEY='healthCloud_badges_v3';
function load(){ try{return JSON.parse(localStorage.getItem(LSKEY))||{students:{}};}catch(e){return {students:{}};} }
function save(d){ localStorage.setItem(LSKEY, JSON.stringify(d)); }
function ensureStudent(d, sid){
  if(!d.students[sid]) d.students[sid]={ name:'', classId:'', school:'', days:{}, streak:0, totals:{points:0, comps:0, badgeBonus:0}, games:{}, badges:{}, playLog:[] };
  for(const k in games){ if(!d.students[sid].games[k]) d.students[sid].games[k]={ sessions:0, completions:0, totalSeconds:0, bestScore:0, bestTime:null }; }
}
function $(q){ return document.querySelector(q); }
function today(){ return new Date().toISOString().slice(0,10); }
function weekStart(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; }
function monthStart(d){ const dt=new Date(d); dt.setDate(1); dt.setHours(0,0,0,0); return dt; }
function inTimeWindow(ts,start,end){
  const t = new Date(ts); const hh = t.getHours()*60 + t.getMinutes();
  const [sH,sM]=start.split(':').map(Number); const [eH,eM]=end.split(':').map(Number);
  const a = sH*60+sM, b=eH*60+eM;
  return hh>=a && hh<=b;
}

let ACTIVE=null;
$('#setStudent').addEventListener('click', ()=>{
  const sid=$('#studentId').value.trim();
  const name=$('#studentName').value.trim();
  const classId=$('#classId').value.trim();
  const school=$('#school').value.trim();
  if(!sid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Student ID');
  const d=load(); ensureStudent(d,sid);
  d.students[sid].name=name; d.students[sid].classId=classId; d.students[sid].school=school;
  save(d); ACTIVE=sid; $('#activeStudentLabel').textContent=`‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${sid} (${name||'-'}) ‚Ä¢ ‡∏´‡πâ‡∏≠‡∏á ${classId||'-'} ‚Ä¢ ${school||''}`;
  render();
});
$('#goProfile').addEventListener('click', ()=>{ if(!ACTIVE){alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');return;} window.open('./profile.html?sid='+encodeURIComponent(ACTIVE),'_blank'); });
$('#resetAll').addEventListener('click', ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')){ localStorage.removeItem(LSKEY); ACTIVE=null; render(); } });
$('#openBtn').addEventListener('click', ()=>{
  if(!ACTIVE) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  const key=$('#gameSelect').value; $('#stage').src=games[key].url;
  const d=load(); ensureStudent(d,ACTIVE);
  const stu=d.students[ACTIVE]; const day=today(); stu.days[day]=true;
  // recompute streak
  const days=Object.keys(stu.days).sort(); let streak=0,last=null;
  for(let i=days.length-1;i>=0;i--){
    const dd=days[i]; if(!last){streak=1; last=dd; continue;}
    const diff=(new Date(last)-new Date(dd))/86400000; if(diff===1){ streak++; last=dd;} else break;
  }
  stu.streak=streak; stu.games[key].sessions+=1; save(d);
});

// BADGES evaluation (weekly/monthly + time-window)
function awardBadgesIfAny(stu){
  const cfg=(window.HealthSuiteConfig && window.HealthSuiteConfig.badges)||[];
  const newly=[];

  const now = new Date();
  const wStart = weekStart(now);
  const mStart = monthStart(now);

  function allGamesCompletedOnce(){ for(const k in games){ if((stu.games[k].completions||0)<1) return false; } return true; }
  function totalCompletions(){ let s=0; for(const k in games){ s+=stu.games[k].completions||0; } return s; }
  function gameScoreAtLeast(key, score){ return (stu.games[key].bestScore||0) >= score; }
  function anyBestTimeLTE(sec){ for(const k in games){ const bt=stu.games[k].bestTime; if(bt!=null && bt<=sec) return true; } return false; }
  function weeklyGameCountAtLeast(key, n){
    return (stu.playLog||[]).filter(x=> x.game===key && new Date(x.ts)>=wStart ).length >= n;
  }
  function weeklyGameCountOnWeekdays(key, n){
    const cnt = (stu.playLog||[]).filter(x=>{
      const t=new Date(x.ts);
      const dow=t.getDay(); // 1..5 = Weekdays
      const weekday = dow>=1 && dow<=5;
      return x.game===key && t>=wStart && weekday;
    }).length;
    return cnt>=n;
  }
  function monthlyGameCountAtLeast(key, n){
    return (stu.playLog||[]).filter(x=> x.game===key && new Date(x.ts)>=mStart ).length >= n;
  }
  function monthlyTimeWindowCountAtLeast(start,end,n){
    const cnt=(stu.playLog||[]).filter(x=> new Date(x.ts)>=mStart && inTimeWindow(x.ts,start,end)).length;
    return cnt>=n;
  }

  for(const b of cfg){
    let ok=false;
    if(b.rule==='allGamesCompletedOnce') ok=allGamesCompletedOnce();
    if(b.rule==='totalCompletionsAtLeast') ok=totalCompletions() >= (b.n||0);
    if(b.rule==='streakAtLeast') ok=(stu.streak||0) >= (b.days||3);
    if(b.rule==='anyBestTimeLTE') ok=anyBestTimeLTE(b.seconds||30);
    if(b.rule==='gameScoreAtLeast') ok=gameScoreAtLeast(b.game, b.score||0);
    if(b.rule==='weeklyGameCountAtLeast') ok=weeklyGameCountAtLeast(b.game, b.n||0);
    if(b.rule==='weeklyGameCountOnWeekdays') ok=weeklyGameCountOnWeekdays(b.game, b.n||0);
    if(b.rule==='monthlyGameCountAtLeast') ok=monthlyGameCountAtLeast(b.game, b.n||0);
    if(b.rule==='monthlyTimeWindowCountAtLeast') ok=monthlyTimeWindowCountAtLeast(b.start||'06:00', b.end||'08:00', b.n||0);

    if(ok && !stu.badges[b.id]){
      stu.badges[b.id]={ label:b.label, bonus:b.bonus||0, at:new Date().toISOString() };
      stu.totals.badgeBonus += (b.bonus||0);
      stu.totals.points     += (b.bonus||0);
      newly.push(b);
    }
  }
  return newly;
}

// RECEIVE COMPLETE
window.addEventListener('message', (e)=>{
  const m=e.data||{}; if(!m.type || !ACTIVE) return;
  const code=m.type.split('_')[0]; const action=m.type.split('_')[1];
  let key=null; for(const k in games){ if(games[k].code===code) key=k; }
  if(!key || action!=='COMPLETE') return;
  const score = (typeof m.score==='number')? m.score : 0;
  const seconds = (typeof m.seconds==='number')? m.seconds : 0;
  const weight = (window.HealthSuiteConfig.points && window.HealthSuiteConfig.points[code]) || 1.0;
  const earned = Math.max(0, Math.round(score * weight));
  const ts = new Date().toISOString();

  const d=load(); ensureStudent(d, ACTIVE);
  const stu=d.students[ACTIVE];
  const g=stu.games[key];
  g.completions += 1; g.totalSeconds += seconds;
  if(score > (g.bestScore||0)) g.bestScore=score;
  if(g.bestTime==null || seconds<g.bestTime) g.bestTime = seconds;
  stu.totals.points += earned; stu.totals.comps += 1;
  stu.playLog.push({ts, game:key, score, seconds});
  const newly=awardBadgesIfAny(stu);
  save(d); render();
  if(newly.length){ alert('‡πÑ‡∏î‡πâ Badge ‡πÉ‡∏´‡∏°‡πà: '+newly.map(b=>b.label+' (+'+b.bonus+')').join(', ')); }
});

// Sheets I/O
async function sendToSheets(){
  const url=(window.HealthSuiteConfig.sheets && window.HealthSuiteConfig.sheets.writeUrl)||'';
  if(!url) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ writeUrl ‡πÉ‡∏ô assets/js/config.js');
  if(!ACTIVE) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  const d=load(); const s=d.students[ACTIVE];
  const payload={ ts:new Date().toISOString(), sid:ACTIVE, name:s.name, classId:s.classId, school:s.school, totals:s.totals, games:s.games, badges:s.badges };
  try{ await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Sheets ‡πÅ‡∏•‡πâ‡∏ß'); }
  catch(err){ alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message); }
}
document.getElementById('syncSend').addEventListener('click', sendToSheets);

async function fetchLeaderboard(params){
  const base=(window.HealthSuiteConfig.sheets && window.HealthSuiteConfig.sheets.readUrl)||'';
  if(!base) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ readUrl ‡πÉ‡∏ô assets/js/config.js');
  const q = Object.entries(params).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
  const url = base + (base.includes('?')? '&':'?') + q;
  try{ const res=await fetch(url); return await res.json(); } catch(err){ alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+err.message); return null; }
}
function fillTable(id, rows, cols){ const tb=document.querySelector('#'+id+' tbody'); tb.innerHTML=''; rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = cols.map(c=> c==='rank'? (i+1) : (r[c]??'') ).map(x=>`<td>${x}</td>`).join(''); tb.appendChild(tr); }); }
document.getElementById('syncFetchClass').addEventListener('click', async ()=>{
  if(!ACTIVE) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); const d=load(); const s=d.students[ACTIVE];
  const js=await fetchLeaderboard({scope:'class', classId:s.classId, school:s.school}); if(!js) return;
  fillTable('tblClass', js.rows, ['rank','sid','name','points','comps']);
});
document.getElementById('syncFetchSchool').addEventListener('click', async ()=>{
  if(!ACTIVE) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); const d=load(); const s=d.students[ACTIVE];
  const js=await fetchLeaderboard({scope:'school', school:s.school}); if(!js) return;
  fillTable('tblSchool', js.rows, ['rank','sid','name','classId','points','comps']);
});
document.getElementById('syncFetchDistrict').addEventListener('click', async ()=>{
  const js=await fetchLeaderboard({scope:'district'}); if(!js) return;
  fillTable('tblDistrict', js.rows, ['rank','sid','name','school','classId','points']);
});

// Export Excel
function weekStartJS(){ return weekStart(new Date()); }
function monthStartJS(){ return monthStart(new Date()); }
function exportExcel(){
  if(!ACTIVE) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  const d=load(); const s=d.students[ACTIVE]; const per=document.getElementById('period').value;
  const start = (per==='week')? weekStartJS() : monthStartJS();
  const log=(s.playLog||[]).filter(x=> new Date(x.ts)>=start).map(x=>({Timestamp:x.ts, Game:x.game, Score:x.score, Seconds:x.seconds}));
  const perGame=Object.keys(s.games||{}).map(k=>({Game:k, Sessions:s.games[k].sessions||0, Completions:s.games[k].completions||0, BestScore:s.games[k].bestScore||0, BestTime:s.games[k].bestTime??''}));
  const badges=Object.keys(s.badges||{}).map(id=>({Badge:id, Label:s.badges[id].label, Bonus:s.badges[id].bonus||0, At:s.badges[id].at}));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(log), per==='week'?'WeeklyLog':'MonthlyLog');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(perGame), 'PerGame');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(badges), 'Badges');
  XLSX.writeFile(wb, `HealthReport_${ACTIVE}_${per}.xlsx`);
}
document.getElementById('exportExcel').addEventListener('click', exportExcel);

function render(){
  const d=load();
  if(ACTIVE && d.students[ACTIVE]){
    const s=d.students[ACTIVE];
    document.getElementById('k_totalPoints').textContent = s.totals.points||0;
    document.getElementById('k_totalComps').textContent  = s.totals.comps||0;
    document.getElementById('k_badgesCount').textContent = Object.keys(s.badges||{}).length;
    document.getElementById('k_badgeBonus').textContent  = s.totals.badgeBonus||0;
  }else{
    ['k_totalPoints','k_totalComps','k_badgesCount','k_badgeBonus'].forEach(id=>document.getElementById(id).textContent='0');
  }
}
render();
</script>
</body>
</html>
