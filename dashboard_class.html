
<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Class Dashboard</title>
<link rel="stylesheet" href="./assets/css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Class Dashboard ‚Äî ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏ß‡∏° & ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á</h1>
  <div class="card">
    <div class="row" style="grid-template-columns:repeat(3,1fr)">
      <div><div class="label">Class ID</div><input id="classId" placeholder="P5-A"/></div>
      <div><div class="label">School</div><input id="school" placeholder="BKK School"/></div>
      <div><div class="label">Top N</div><input id="topN" type="number" value="20"/></div>
    </div>
    <div class="controls">
      <button id="load" class="btn">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button id="export" class="btn secondary">Export Excel</button>
    </div>
  </div>

  <div class="card">
    <h2>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Top N</h2>
    <canvas id="chart" height="140"></canvas>
  </div>

  <div class="card">
    <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á</h2>
    <table class="table" id="tbl">
      <thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>SID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡πÄ‡∏Å‡∏°‡∏à‡∏ö</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
function $(q){ return document.querySelector(q); }
async function fetchClass(){
  try{
    const readUrl = (window.opener && window.opener.HealthSuiteConfig && window.opener.HealthSuiteConfig.sheets.readUrl) || '';
    if(!readUrl){ alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å Hub ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ readUrl ‡πÉ‡∏ô config.js'); return null; }
    const cls=$('#classId').value.trim(), sch=$('#school').value.trim();
    const url = readUrl + (readUrl.includes('?')?'&':'?') + 'scope=class&classId='+encodeURIComponent(cls)+'&school='+encodeURIComponent(sch);
    const res=await fetch(url); return await res.json();
  }catch(e){ alert('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message); return null; }
}
let chart=null;
function render(rows){
  rows.sort((a,b)=> (b.points||0)-(a.points||0));
  const topN=parseInt($('#topN').value||'20',10);
  const top=rows.slice(0,topN);
  const ctx=$('#chart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels:top.map(x=>x.name||x.sid),datasets:[{label:'Points',data:top.map(x=>x.points||0)}]},options:{responsive:true}});
  const tb=$('#tbl tbody'); tb.innerHTML=''; top.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.sid}</td><td>${r.name}</td><td>${r.points}</td><td>${r.comps}</td>`; tb.appendChild(tr); });
}
document.getElementById('load').addEventListener('click', async ()=>{ const js=await fetchClass(); if(js&&js.rows) render(js.rows); });
document.getElementById('export').addEventListener('click', ()=>{
  const tb=document.querySelector('#tbl'); const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(tb); XLSX.utils.book_append_sheet(wb, ws, 'Class');
  XLSX.writeFile(wb, 'ClassDashboard.xlsx');
});
</script>
</body>
</html>
